<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IT Job Market — Interactive Plotly Chart</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; margin: 16px; }
    #controls { margin-bottom: 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    select, button, input { padding:6px 10px; font-size:14px; }
    #chart { width:100%; max-width:1100px; height:600px; }
    .small { font-size:13px; color:#444; }
  </style>
</head>
<body>
  <h2>IT Job Market — Interactive Chart</h2>
  <div id="controls">
    <label class="small">Role:
      <select id="roleSelect" multiple size="6" style="min-width:220px;"></select>
    </label>

    <label class="small">Year range:
      <input id="yearMin" type="number" style="width:84px" />
      —
      <input id="yearMax" type="number" style="width:84px" />
    </label>

    <label class="small">Load CSV:
      <input id="csvFile" type="file" accept=".csv" />
    </label>
    <button id="loadCsvBtn">Load CSV</button>

    <button id="applyBtn">Apply</button>
    <button id="resetBtn">Reset</button>
    <button id="downloadCsv">Download CSV</button>
  </div>

  <div id="chart" aria-label="Interactive plotly chart"></div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    // Sample dataset — replace with your dataset
    const sampleData = [
      {role:"Data Scientist", year:2016, avg_salary:110000, openings:4200, region:"US"},
      {role:"Data Scientist", year:2017, avg_salary:115000, openings:5200, region:"US"},
      {role:"Data Scientist", year:2018, avg_salary:120000, openings:6800, region:"US"},
      {role:"Data Scientist", year:2019, avg_salary:125000, openings:7200, region:"US"},
      {role:"Data Scientist", year:2020, avg_salary:127000, openings:6500, region:"US"},
      {role:"Data Scientist", year:2021, avg_salary:135000, openings:8000, region:"US"},
      {role:"Data Scientist", year:2022, avg_salary:140000, openings:9200, region:"US"},
      {role:"Data Engineer", year:2016, avg_salary:105000, openings:3500, region:"US"},
      {role:"Data Engineer", year:2017, avg_salary:110000, openings:4300, region:"US"},
      {role:"Data Engineer", year:2018, avg_salary:115000, openings:5100, region:"US"},
      {role:"Data Engineer", year:2019, avg_salary:118000, openings:5600, region:"US"},
      {role:"Data Engineer", year:2020, avg_salary:120000, openings:5800, region:"US"},
      {role:"Data Engineer", year:2021, avg_salary:125000, openings:7000, region:"US"},
      {role:"ML Engineer", year:2017, avg_salary:125000, openings:2100, region:"US"},
      {role:"ML Engineer", year:2018, avg_salary:130000, openings:2600, region:"US"},
      {role:"ML Engineer", year:2019, avg_salary:135000, openings:3200, region:"US"},
      {role:"ML Engineer", year:2020, avg_salary:138000, openings:3000, region:"US"},
      {role:"Business Analyst", year:2016, avg_salary:80000, openings:6100, region:"US"},
      {role:"Business Analyst", year:2017, avg_salary:82000, openings:6400, region:"US"},
      {role:"Business Analyst", year:2018, avg_salary:85000, openings:7000, region:"US"},
      {role:"Business Analyst", year:2019, avg_salary:87000, openings:6700, region:"US"},
      {role:"Business Analyst", year:2020, avg_salary:88000, openings:5000, region:"US"},
      {role:"Business Analyst", year:2021, avg_salary:90000, openings:5600, region:"US"},
      {role:"Research Scientist", year:2018, avg_salary:145000, openings:1200, region:"US"},
      {role:"Research Scientist", year:2019, avg_salary:150000, openings:1500, region:"US"},
      {role:"Research Scientist", year:2020, avg_salary:155000, openings:1700, region:"US"}
    ];

    const roles = Array.from(new Set(sampleData.map(d => d.role))).sort();
    const years = Array.from(new Set(sampleData.map(d => d.year))).sort((a,b)=>a-b);

    const roleSelect = document.getElementById('roleSelect');
    roles.forEach(r => {
      const opt = document.createElement('option'); opt.value = r; opt.textContent = r; opt.selected = true; roleSelect.appendChild(opt);
    });

    document.getElementById('yearMin').value = Math.min(...years);
    document.getElementById('yearMax').value = Math.max(...years);

    // Increase Research Scientist bubble size
    const roleSizeMultiplier = { 'Research Scientist': 4.0 };

    // compute automatic sizeref for Plotly when using sizemode: 'area'
    function computeSizeRef(data) {
      const maxOpenings = Math.max(...data.map(d => d.openings));
      // target max marker area ~ 2000 (tunable) => sizeref = 2.0 * max_area / (max_size^2)
      // simpler: sizeref = maxOpenings / 40
      return Math.max(1, Math.round(maxOpenings / 40));
    }

    function buildTraces(filteredData) {
      const grouped = {};
      filteredData.forEach(d => { grouped[d.role] = grouped[d.role] || []; grouped[d.role].push(d); });
      const all = filteredData.slice();
      const sizeref = computeSizeRef(all);

      return Object.keys(grouped).map(role => {
        const arr = grouped[role].sort((a,b)=>a.year-b.year);
        const baseAreas = arr.map(d => Math.max(8, Math.min(2000, d.openings)));
        const multiplier = roleSizeMultiplier[role] || 1;
        const areas = baseAreas.map(a => Math.round(a * multiplier));

        return {
          x: arr.map(d => d.year),
          y: arr.map(d => d.avg_salary),
          text: arr.map(d => `${d.role || role}<br>Year: ${d.year}<br>Salary: $${d.avg_salary.toLocaleString()}<br>Openings: ${d.openings}`),
          customdata: arr.map(d => ({openings: d.openings, region: d.region})),
          hovertemplate: '%{text}' + '<' + 'extra' + '>' + '</' + 'extra' + '>',
          mode: 'lines+markers',
          marker: { size: areas, sizemode: 'area', sizeref: sizeref },
          name: role
        };
      });
    }

    const chartDiv = document.getElementById('chart');
    const initialTraces = buildTraces(sampleData);

    const layout = {
      title: 'Average Salary by Role (bubble ~ openings)',
      xaxis: { title: 'Year', type: 'linear', tick0: years[0], dtick: 1, rangeslider: {visible: true} },
      yaxis: { title: 'Average Salary (USD)', tickprefix: '$' },
      legend: { orientation: 'h', x: 0, y: 1.12 },
      margin: { t:70, b:60, l:80, r:30 },
      hovermode: 'closest',
      annotations: [{ xref: 'paper', yref: 'paper', x: 1, xanchor: 'right', y: -0.18, showarrow:false, text: 'Data: sample — replace with your dataset' }]
    };

    const config = { responsive: true, toImageButtonOptions: {format: 'png', filename: 'it_job_market', height: 800, width: 1200, scale: 1} };

    Plotly.newPlot(chartDiv, initialTraces, layout, config);

    function updateChart() {
      const selectedRoles = Array.from(roleSelect.selectedOptions).map(o => o.value);
      const minY = Number(document.getElementById('yearMin').value) || years[0];
      const maxY = Number(document.getElementById('yearMax').value) || years[years.length-1];
      const filtered = sampleData.filter(d => selectedRoles.includes(d.role) && d.year >= minY && d.year <= maxY);
      const traces = buildTraces(filtered);
      Plotly.react(chartDiv, traces, layout, config);
    }

    document.getElementById('applyBtn').addEventListener('click', updateChart);
    document.getElementById('resetBtn').addEventListener('click', () => { Array.from(roleSelect.options).forEach(o => o.selected = true); document.getElementById('yearMin').value = Math.min(...years); document.getElementById('yearMax').value = Math.max(...years); Plotly.react(chartDiv, initialTraces, layout, config); });

    // CSV parsing: expects header with role,year,avg_salary,openings,region
    function parseCsvText(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (lines.length < 2) return [];
      const headers = lines[0].split(/,\s*/).map(h => h.replace(/^"|"$/g, '').toLowerCase());
      const out = [];
      for (let i=1;i<lines.length;i++) {
        const cols = lines[i].split(/,\s*/).map(c => c.replace(/^"|"$/g, ''));
        const row = {};
        headers.forEach((h,idx) => row[h] = cols[idx]);
        // coerce types
        if (!row.role || !row.year) continue;
        out.push({ role: row.role, year: +row.year, avg_salary: +row.avg_salary || 0, openings: +row.openings || 0, region: row.region || '' });
      }
      return out;
    }

    document.getElementById('loadCsvBtn').addEventListener('click', () => {
      const f = document.getElementById('csvFile').files[0];
      if (!f) { alert('Select a CSV file first'); return; }
      const reader = new FileReader();
      reader.onload = (ev) => {
        const parsed = parseCsvText(ev.target.result);
        if (!parsed.length) { alert('No rows parsed from CSV'); return; }
        // replace sampleData in-place
        sampleData.length = 0; parsed.forEach(r => sampleData.push(r));
        // rebuild controls
        const newRoles = Array.from(new Set(sampleData.map(d => d.role))).sort();
        roleSelect.innerHTML = '';
        newRoles.forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; opt.selected = true; roleSelect.appendChild(opt); });
        const newYears = Array.from(new Set(sampleData.map(d => d.year))).sort((a,b)=>a-b);
        document.getElementById('yearMin').value = Math.min(...newYears);
        document.getElementById('yearMax').value = Math.max(...newYears);
        Plotly.react(chartDiv, buildTraces(sampleData), layout, config);
      };
      reader.readAsText(f);
    });

    document.getElementById('downloadCsv').addEventListener('click', () => {
      const gd = chartDiv; const plotted = gd.data || []; const rows = [['role','year','avg_salary','openings','region']];
      plotted.forEach(trace => { const role = trace.name || ''; if (!trace.x) return; for (let i=0;i<trace.x.length;i++){ const year = trace.x[i]; const salary = trace.y ? trace.y[i] : ''; const openings = (trace.customdata && trace.customdata[i] && trace.customdata[i].openings) ? trace.customdata[i].openings : ''; const region = (trace.customdata && trace.customdata[i] && trace.customdata[i].region) ? trace.customdata[i].region : ''; rows.push([role, year, salary, openings, region]); } });
      const csvContent = rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'it_job_market.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    roleSelect.addEventListener('keydown', (e) => { if (e.key === 'Enter') updateChart(); });
  </script>
</body>
</html>
